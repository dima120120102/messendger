<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–π –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Poppins', sans-serif;
    }
    
    body {
        background: linear-gradient(135deg, #1e1b3e, #3b2f6b);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow: hidden;
        color: #fff;
    }
    
    .container {
        width: 90%;
        max-width: 1000px;
        height: 85vh;
        max-height: 800px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(12px);
        display: flex;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
    }
    
    .sidebar {
        width: 320px;
        background: rgba(255, 255, 255, 0.03);
        border-right: 1px solid rgba(255, 255, 255, 0.08);
        display: flex;
        flex-direction: column;
        transition: width 0.3s ease;
    }
    
    .user-actions {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        position: relative;
    }
    
    .menu-btn {
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        color: #fff;
        border: none;
        border-radius: 25px;
        padding: 10px 20px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 87, 127, 0.3);
    }
    
    .menu-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(255, 87, 127, 0.5);
    }
    
    .dropdown-menu {
        position: absolute;
        top: 60px;
        left: 15px;
        background: rgba(255, 255, 255, 0.08);
        border-radius: 15px;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        z-index: 1000;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from { transform: translateY(-15px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .dropdown-menu button {
        padding: 10px 20px;
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        color: #fff;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(255, 87, 127, 0.2);
    }
    
    .dropdown-menu button:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(255, 87, 127, 0.4);
    }
    
    .dropdown-menu #deleteProfileButton {
        background: linear-gradient(135deg, #ff3d3d, #ff6b6b);
    }
    
    .dropdown-menu #logoutButton {
        background: linear-gradient(135deg, #ff9f43, #ffcc66);
    }
    
    .search-area {
        padding: 15px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        position: relative;
    }
    
    .search-area input {
        width: 100%;
        padding: 12px 40px 12px 15px;
        border: none;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 0.95em;
        outline: none;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .search-area input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }
    
    .search-area input:focus {
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
    }
    
    .clear-search-btn {
        position: absolute;
        right: 30px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: rgba(255, 255, 255, 0.5);
        cursor: pointer;
        font-size: 1.1em;
        transition: all 0.3s ease;
    }
    
    .clear-search-btn:hover {
        color: #ff9f43;
        transform: translateY(-50%) scale(1.2);
    }
    
    #contactList {
        flex: 1;
        overflow-y: auto;
        padding: 10px 0;
    }
    
    .contact {
        padding: 12px 20px;
        display: flex;
        align-items: center;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .contact:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
    }
    
    .contact.active {
        background: rgba(255, 255, 255, 0.15);
        box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.05);
    }
    
    .contact-avatar {
        width: 45px;
        height: 45px;
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 1.2em;
        font-weight: 500;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .contact-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .contact:hover .contact-avatar {
        transform: scale(1.05);
    }
    
    .contact-name {
        color: #fff;
        font-weight: 500;
        font-size: 1em;
        flex: 1;
    }
    
    .request-join-btn {
        background: linear-gradient(135deg, #6b48ff, #57feca);
        color: #fff;
        border: none;
        padding: 6px 12px;
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(107, 72, 255, 0.2);
    }
    
    .request-join-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 5px 15px rgba(107, 72, 255, 0.4);
    }
    
    .messenger {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .header {
        background: rgba(255, 255, 255, 0.03);
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 1.2em;
        font-weight: 500;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .header span {
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .header button {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.4em;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .header button:hover {
        color: #ff9f43;
        transform: scale(1.15);
    }
    
    .chat {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: transparent;
    }
    
    .message {
        margin-bottom: 15px;
        padding: 12px 18px;
        border-radius: 15px;
        max-width: 70%;
        word-wrap: break-word;
        animation: fadeIn 0.3s ease-out;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .message:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
    }
    
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message.own-message {
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        color: #fff;
        margin-left: auto;
        border-bottom-right-radius: 4px;
    }
    
    .message.other-message {
        background: rgba(255, 255, 255, 0.95);
        color: #2b1b5e;
        border-bottom-left-radius: 4px;
    }
    
    .message.system-message {
        background: rgba(255, 255, 255, 0.25);
        color: #fff;
        margin: 10px auto;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        text-align: center;
        max-width: 80%;
        position: relative;
        overflow: hidden;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
    }
    
    .message.system-message::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, rgba(255, 87, 127, 0.15), rgba(255, 159, 67, 0.15));
        z-index: -1;
        animation: pulse 2s infinite ease-in-out;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 0.3; }
        50% { opacity: 0.6; }
    }
    
    .message .sender-name {
        font-size: 0.85em;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 5px;
        font-weight: 500;
    }
    
    .message.other-message .sender-name {
        color: rgba(43, 27, 94, 0.9);
    }
    
    .message .timestamp {
        font-size: 0.7em;
        color: rgba(255, 255, 255, 0.6);
        margin-top: 5px;
        text-align: right;
        display: block;
    }
    
    .message.other-message .timestamp {
        color: rgba(43, 27, 94, 0.6);
    }
    
    .message-media {
        max-width: 200px;
        margin-top: 8px;
        border-radius: 10px;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
        transition: all 0.3s ease;
    }
    
    .message-media:hover {
        transform: scale(1.02);
    }
    
    .message-media[src$=".mp4"],
    .message-media[src$=".webm"] {
        max-height: 200px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è */
    
    
    /* –ö–∞—Å—Ç–æ–º–∏–∑–∞—Ü–∏—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –∞—É–¥–∏–æ–ø–ª–µ–µ—Ä–∞ */
    .voice-audio::-webkit-media-controls-panel {
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        border-radius: 20px;
        padding: 5px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .own-message .voice-audio::-webkit-media-controls-panel {
        background: rgba(255, 255, 255, 0.15);
    }
    
    .other-message .voice-audio::-webkit-media-controls-panel {
        background: rgba(43, 27, 94, 0.1);
    }
    
    .voice-audio::-webkit-media-controls-play-button,
    .voice-audio::-webkit-media-controls-volume-slider,
    .voice-audio::-webkit-media-controls-mute-button {
        filter: brightness(1.2);
    }
    
    .voice-audio::-webkit-media-controls-current-time-display,
    .voice-audio::-webkit-media-controls-time-remaining-display {
        color: #fff;
        font-size: 0.85em;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    
    .other-message .voice-audio::-webkit-media-controls-current-time-display,
    .other-message .voice-audio::-webkit-media-controls-time-remaining-display {
        color: #2b1b5e;
    }
    
    .voice-audio::-webkit-media-controls-timeline {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        height: 4px;
    }
    
    .voice-audio::-webkit-media-controls-timeline::-webkit-slider-thumb {
        background: #ff9f43;
        border-radius: 50%;
        width: 12px;
        height: 12px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .input-area {
        padding: 15px;
        background: rgba(255, 255, 255, 0.03);
        border-top: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .media-preview {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        position: relative;
    }
    
    .media-preview img,
    .media-preview video,
    .media-preview audio {
        max-width: 120px;
        max-height: 120px;
        border-radius: 10px;
        object-fit: cover;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .media-preview img:hover,
    .media-preview video:hover {
        transform: scale(1.05);
    }
    
    .cancel-media-btn {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(255, 61, 61, 0.9);
        color: #fff;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .cancel-media-btn:hover {
        background: #ff3d3d;
        transform: scale(1.15);
    }
    
    .input-controls {
        display: flex;
        align-items: center;
    }
    
    .input-area input {
        flex: 1;
        padding: 12px 15px;
        border: none;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 1em;
        outline: none;
        margin-right: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .input-area input::placeholder {
        color: rgba(255, 255, 255, 0.4);
    }
    
    .input-area input:focus {
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
    }
    
    .media-btn {
        color: #fff;
        font-size: 1.4em;
        cursor: pointer;
        margin-right: 15px;
        transition: all 0.3s ease;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .media-btn:hover {
        color: #ff9f43;
        transform: scale(1.15);
    }
    
    .media-btn.recording {
        color: #ff577f;
        animation: pulse 1s infinite ease-in-out;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.25); }
        100% { transform: scale(1); }
    }
    
    .input-area button {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        color: #fff;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.4em;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 87, 127, 0.3);
    }
    
    .input-area button:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(255, 87, 127, 0.5);
    }
    
    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ –∑–≤—É–∫–∞ */
    #audioWaveform {
        width: 100%;
        height: 60px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        margin-bottom: 10px;
        position: relative;
        overflow: hidden;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
    }
    
    #audioWaveform.recording::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, rgba(255, 87, 127, 0.2), rgba(255, 159, 67, 0.2));
        animation: waveBackground 3s infinite ease-in-out;
    }
    
    @keyframes waveBackground {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }
    
    #audioWaveform.recording::after {
        content: '–ó–∞–ø–∏—Å—å...';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #ff577f;
        font-size: 0.9em;
        font-weight: 500;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        animation: pulseText 1s infinite ease-in-out;
    }
    
    @keyframes pulseText {
        0% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
        50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
        100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
    }
    
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.75);
        backdrop-filter: blur(6px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        animation: fadeInModal 0.3s ease-out;
    }
    
    @keyframes fadeInModal {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .modal-content {
        background: rgba(255, 255, 255, 0.08);
        border-radius: 20px;
        padding: 30px;
        width: 90%;
        max-width: 450px;
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(12px);
        animation: slideIn 0.4s ease-out;
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
    }
    
    @keyframes slideIn {
        from { transform: translateY(-25px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
    
    .group-modal {
        max-width: 600px;
        padding: 35px;
    }
    
    .confirm-modal {
        border: 2px solid rgba(255, 61, 61, 0.4);
        box-shadow: 0 0 25px rgba(255, 61, 61, 0.25);
        max-width: 400px;
    }
    
    .loading-modal {
        max-width: 300px;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    
    .spinner {
        width: 40px;
        height: 40px;
        border: 5px solid rgba(255, 255, 255, 0.15);
        border-top: 5px solid #ff9f43;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 15px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .modal-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        color: #fff;
        font-size: 1.5em;
        cursor: pointer;
        width: 32px;
        height: 32px;
        line-height: 32px;
        text-align: center;
        border-radius: 50%;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    .modal-close-btn:hover {
        color: #ff577f;
        background: rgba(255, 255, 255, 0.2);
        transform: scale(1.1);
    }
    
    .modal-content h2 {
        font-size: 1.8em;
        margin-bottom: 25px;
        margin-top: 10px;
        font-weight: 500;
        text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .modal-content h3 {
        font-size: 1.2em;
        margin-bottom: 15px;
        font-weight: 500;
    }
    
    .modal-content p {
        font-size: 0.95em;
        margin-bottom: 20px;
    }
    
    .modal-content input,
    .modal-content textarea {
        width: 100%;
        padding: 12px 15px;
        border: none;
        border-radius: 25px;
        background: rgba(255, 255, 255, 0.1);
        color: #fff;
        font-size: 0.95em;
        outline: none;
        margin-bottom: 15px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .modal-content input[type="file"] {
        background: none;
        padding: 5px;
        box-shadow: none;
    }
    
    .modal-content input:focus,
    .modal-content textarea:focus {
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
    }
    
    .modal-content textarea {
        height: 100px;
        resize: none;
        border-radius: 15px;
    }
    
    .modal-content button {
        padding: 12px 25px;
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        color: #fff;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 87, 127, 0.3);
    }
    
    .modal-content button:disabled {
        background: linear-gradient(135deg, #888, #bbb);
        cursor: not-allowed;
        box-shadow: none;
    }
    
    .modal-content button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(255, 87, 127, 0.5);
    }
    
    .toggle-link {
        color: #ff9f43;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s ease;
    }
    
    .toggle-link:hover {
        color: #ff577f;
        text-decoration: underline;
    }
    
    .profile-picture {
        margin: 20px 0;
        text-align: center;
    }
    
    .profile-picture img {
        width: 130px;
        height: 130px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
        transition: all 0.3s ease;
    }
    
    .profile-picture img:hover {
        transform: scale(1.05);
    }
    
    .group-avatar-preview {
        margin: 20px auto;
        text-align: center;
    }
    
    .group-avatar-preview img {
        width: 110px;
        height: 110px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.25);
        transition: all 0.3s ease;
    }
    
    .group-avatar-preview img:hover {
        transform: scale(1.05);
    }
    
    .avatar-upload-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #6b48ff, #57feca);
        color: #fff;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(107, 72, 255, 0.2);
    }
    
    .avatar-upload-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(107, 72, 255, 0.4);
    }
    
    .group-members-container {
        max-height: 200px;
        overflow-y: auto;
        margin-top: 20px;
    }
    
    .group-members-container::-webkit-scrollbar,
    .chat::-webkit-scrollbar,
    #contactList::-webkit-scrollbar {
        width: 8px;
    }
    
    .group-members-container::-webkit-scrollbar-track,
    .chat::-webkit-scrollbar-track,
    #contactList::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }
    
    .group-members-container::-webkit-scrollbar-thumb,
    .chat::-webkit-scrollbar-thumb,
    #contactList::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        border-radius: 8px;
    }
    
    .group-members-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .group-member-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .group-member-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }
    
    .group-member-item label {
        display: flex;
        align-items: center;
        width: 100%;
        cursor: pointer;
    }
    
    .group-member-item input[type="checkbox"] {
        margin-right: 12px;
        width: 18px;
        height: 18px;
    }
    
    .member-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 1.1em;
        font-weight: 500;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .member-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .group-member-item:hover .member-avatar {
        transform: scale(1.05);
    }
    
    .group-member-item span {
        font-size: 0.95em;
    }
    
    .group-members-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
    }
    
    .add-members-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #6b48ff, #57feca);
        color: #fff;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(107, 72, 255, 0.2);
    }
    
    .add-members-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(107, 72, 255, 0.4);
    }
    
    .group-owner-info {
        margin: 20px 0;
    }
    
    #groupOwnerDetails {
        display: flex;
        align-items: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .owner-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 1.1em;
        font-weight: 500;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
    }
    
    .owner-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    
    #groupOwnerDetails span {
        font-size: 0.95em;
    }
    
    .group-requests {
        margin: 20px 0;
    }
    
    .requests-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .request-item {
        display: flex;
        align-items: center;
        padding: 10px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .request-item:hover {
        background: rgba(255, 255, 255, 0.1);
        transform: translateX(5px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
    }
    
    .request-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 12px;
        font-size: 1.1em;
        font-weight: 500;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.2);
    }
    
    .request-avatar img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .request-username {
        font-size: 0.95em;
        flex: 1;
    }
    
    .request-actions {
        display: flex;
        gap: 10px;
    }
    
    .approve-btn,
    .reject-btn {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.2em;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .approve-btn:hover {
        color: #57feca;
        transform: scale(1.15);
    }
    
    .reject-btn:hover {
        color: #ff577f;
        transform: scale(1.15);
    }
    
    .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin-top: 25px;
    }
    
    .modal-buttons button {
        width: 150px;
    }
    
    #deleteGroupButton {
        background: linear-gradient(135deg, #ff3d3d, #ff6b6b);
    }
    
    #leaveGroupButton {
        background: linear-gradient(135deg, #ff9f43, #ffcc66);
    }
    
    .member-actions-modal {
        position: absolute;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 15px;
        padding: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 2000;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        animation: slideDown 0.3s ease-out;
    }
    
    .member-action-btn {
        padding: 10px 20px;
        background: linear-gradient(135deg, #ff577f, #ff9f43);
        color: #fff;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(255, 87, 127, 0.2);
    }
    
    .member-action-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(255, 87, 127, 0.4);
    }
    
    #removeMemberButton {
        background: linear-gradient(135deg, #ff3d3d, #ff6b6b);
    }
    
    #toggleAdminButton {
        background: linear-gradient(135deg, #6b48ff, #57feca);
    }
    
    .confirm-modal label {
        display: flex;
        align-items: center;
        font-size: 0.9em;
        margin: 20px 0;
    }
    
    .confirm-modal input[type="checkbox"] {
        margin-right: 12px;
        width: 18px;
        height: 18px;
    }
    
    /* –°–ø–µ—Ü–∏—Ñ–∏—á–µ—Å–∫–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–æ—Ñ–∏–ª—è */
    #viewProfileModal .modal-content {
        padding: 15px 30px 30px 30px;
        position: relative;
    }
    
    #viewProfileModal .modal-buttons {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
        margin-top: 30px;
    }
    
    #viewProfileModal .modal-buttons button {
        width: 100%;
        max-width: 220px;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–í—ã–π—Ç–∏" –∏ "–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å" */
    #logoutButton {
        background: linear-gradient(135deg, #ff9f43, #ffcc66);
    }
    
    #deleteProfileButton {
        background: linear-gradient(135deg, #ff3d3d, #ff6b6b);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è */
    #editProfileModal .modal-content {
        padding: 30px;
        padding-bottom: 80px;
        position: relative;
        max-height: 85vh;
        overflow-y: auto;
        box-sizing: border-box;
    }
    
    /* –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
    #editProfilePicturePreview {
        display: block;
        max-width: 100%;
        max-height: 220px;
        margin: 15px 0;
        object-fit: contain;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    #editProfilePicturePreview:hover {
        transform: scale(1.02);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è */
    #editProfileModal .modal-buttons {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 20px;
        justify-content: center;
        width: 100%;
        max-width: 450px;
        padding: 0 20px;
        box-sizing: border-box;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å" */
    #editProfileButton {
        background: linear-gradient(135deg, #6b48ff, #57feca);
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ */
    #viewProfileModal p {
        font-size: 0.95em;
        margin: 12px 0;
    }
    
    #viewProfileModal p strong {
        color: #ff9f43;
    }
    
    #editProfileModal label {
        font-size: 0.9em;
        margin-bottom: 8px;
        display: block;
    }
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
    #voicePreviewModal .modal-content {
        max-width: 500px;
    }
    
    #voicePreviewAudio {
        width: 100%;
        margin-bottom: 20px;
        border-radius: 10px;
    }
    
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .container {
            width: 95%;
            height: 90vh;
        }
    
        .sidebar {
            width: 250px;
        }
    
        .contact-avatar {
            width: 40px;
            height: 40px;
        }
    
        .contact-name {
            font-size: 0.9em;
        }
    
        .header {
            font-size: 1em;
        }
    
        .message {
            max-width: 80%;
        }
    
        .modal-content {
            max-width: 90%;
        }
    
        .group-modal {
            max-width: 90%;
            padding: 25px;
        }
    }
    
    @media (max-width: 480px) {
        .sidebar {
            width: 200px;
        }
    
        .menu-btn {
            padding: 8px 15px;
        }
    
        .dropdown-menu {
            top: 55px;
            left: 10px;
        }
    
        .contact {
            padding: 10px 15px;
        }
    
        .contact-avatar {
            width: 35px;
            height: 35px;
        }
    
        .input-area button {
            width: 45px;
            height: 45px;
        }
    
        .modal-buttons {
            flex-direction: column;
            gap: 15px;
        }
    
        .modal-buttons button {
            width: 100%;
        }
    
        .group-members-container {
            max-height: 150px;
        }
    }
</style>
</head>
<body>
    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –≤—Ö–æ–¥–∞ -->
    <div class="modal" id="authModal">
        <div class="modal-content">
            <h2 id="modalTitle">–í—Ö–æ–¥</h2>
            <input type="email" id="emailInput" placeholder="Email">
            <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="authButton">–í–æ–π—Ç–∏</button>
            <span class="toggle-link" id="toggleAuth">–ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å!</span>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="modal" id="registerModal" style="display: none;">
        <div class="modal-content">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
            <input type="text" id="usernameInput" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="email" id="registerEmailInput" placeholder="Email">
            <input type="password" id="registerPasswordInput" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="registerButton">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <span class="toggle-link" id="toggleLogin">–£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? –í–æ–π–¥–∏—Ç–µ!</span>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
    <div class="modal" id="awaitConfirmationModal" style="display: none;">
        <div class="modal-content">
            <h2>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ Email</h2>
            <p>–ú—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø–∏—Å—å–º–æ —Å —Å—Å—ã–ª–∫–æ–π –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –Ω–∞ –≤–∞—à email. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ, —á—Ç–æ–±—ã –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é.</p>
            <button id="cancelAwaitButton">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div class="modal" id="loadingModal" style="display: none;">
        <div class="modal-content loading-modal">
            <div class="spinner"></div>
            <p>–°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã...</p>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal" id="viewProfileModal" style="display: none;">
        <div class="modal-content">
            <button class="modal-close-btn">√ó</button>
            <h2 id="viewProfileUsername"></h2>
            <p><strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫:</strong> <span id="viewProfileUniqueUsername"></span></p>
            <div class="profile-picture">
                <img id="viewProfilePicture" src="" alt="–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è" style="display: none;">
            </div>
            <p><strong>–û —Å–µ–±–µ:</strong> <span id="viewProfileBio"></span></p>
            <p><strong>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</strong> <span id="viewProfileBirthdate"></span></p>
            <button id="editProfileButton" style="display: none;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="editProfileModal" class="modal" style="display: none;">
        <div class="modal-content">
            <button id="cancelEditProfileButton" class="modal-close-btn">‚úñ</button>
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
            <input id="editUsernameInput" type="text" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <label>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫:</label>
            <input id="uniqueUsernameInput" type="text" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫">
            <label>–§–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è:</label>
            <input id="profilePictureInput" type="file" accept="image/*">
            <img id="editProfilePicturePreview" style="display: none;" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä">
            <label>–ë–∏–æ–≥—Ä–∞—Ñ–∏—è:</label>
            <textarea id="bioInput" placeholder="–û —Å–µ–±–µ"></textarea>
            <label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è:</label>
            <input id="birthdateInput" type="date">
            <button id="saveProfileButton">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div class="modal" id="createGroupModal" style="display: none;">
        <div class="modal-content group-modal">
            <h2>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
            <div class="group-avatar-preview">
                <img id="groupAvatarPreview" src="" alt="–ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã" style="display: none;">
                <label for="groupAvatarInput" class="avatar-upload-btn">–í—ã–±—Ä–∞—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
                <input type="file" id="groupAvatarInput" accept="image/*" style="display: none;">
            </div>
            <input type="text" id="groupNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            <input type="text" id="groupUniqueUsernameInput" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, @MyGroup)">
            <textarea id="groupDescriptionInput" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"></textarea>
            <div class="group-members-container">
                <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                <div id="groupMembersList" class="group-members-list"></div>
            </div>
            <div class="modal-buttons">
                <button id="createGroupButton">–°–æ–∑–¥–∞—Ç—å</button>
                <button id="cancelGroupButton">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div class="modal" id="editGroupModal" style="display: none;">
        <div class="modal-content group-modal">
            <button id="closeEditGroupModal" class="modal-close-btn">‚úñ</button>
            <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–ø–ø—É</h2>
            <div class="group-avatar-preview">
                <img id="editGroupAvatarPreview" src="" alt="–ê–≤–∞—Ç–∞—Ä –≥—Ä—É–ø–ø—ã" style="display: none;">
                <label for="editGroupAvatarInput" class="avatar-upload-btn">–ò–∑–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</label>
                <input type="file" id="editGroupAvatarInput" accept="image/*" style="display: none;">
            </div>
            <input type="text" id="editGroupNameInput" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
            <input type="text" id="editGroupUniqueUsernameInput" placeholder="–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, @MyGroup)">
            <textarea id="editGroupDescriptionInput" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã"></textarea>
            <div id="groupOwnerInfo" class="group-owner-info">
                <h3>–°–æ–∑–¥–∞—Ç–µ–ª—å –≥—Ä—É–ø–ø—ã</h3>
                <div id="groupOwnerDetails"></div>
            </div>
            <div class="group-members-container">
                <div class="group-members-header">
                    <h3>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                    <button id="addMembersButton" class="add-members-btn">–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</button>
                </div>
                <div id="editGroupMembersList" class="group-members-list"></div>
            </div>
            <div class="group-requests" id="groupRequests" style="display: none;"></div>
            <div class="modal-buttons">
                <button id="saveGroupButton">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="leaveGroupButton">–í—ã–π—Ç–∏ –∏–∑ –≥—Ä—É–ø–ø—ã</button>
                <button id="deleteGroupButton">–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã -->
    <div class="modal" id="deleteGroupConfirmModal" style="display: none;">
        <div class="modal-content confirm-modal">
            <h2>–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            <label>
                <input type="checkbox" id="deleteGroupConfirmCheckbox">
                –Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ
            </label>
            <div class="modal-buttons">
                <button id="confirmDeleteGroupButton" disabled>–£–¥–∞–ª–∏—Ç—å</button>
                <button id="cancelDeleteGroupButton">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –≥—Ä—É–ø–ø—ã -->
    <div class="modal" id="leaveGroupConfirmModal" style="display: none;">
        <div class="modal-content confirm-modal">
            <h2>–í—ã–π—Ç–∏ –∏–∑ –≥—Ä—É–ø–ø—ã?</h2>
            <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —ç—Ç—É –≥—Ä—É–ø–ø—É?</p>
            <label>
                <input type="checkbox" id="leaveGroupConfirmCheckbox">
                –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é –≤—ã—Ö–æ–¥
            </label>
            <div class="modal-buttons">
                <button id="confirmLeaveGroupButton" disabled>–í—ã–π—Ç–∏</button>
                <button id="cancelLeaveGroupButton">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π —Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º -->
    <div class="member-actions-modal" id="memberActionsModal" style="display: none;">
        <button class="member-action-btn" id="removeMemberButton">–£–¥–∞–ª–∏—Ç—å –∏–∑ –≥—Ä—É–ø–ø—ã</button>
        <button class="member-action-btn" id="messageMemberButton">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –õ–°</button>
        <button class="member-action-btn" id="viewMemberProfileButton">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
        <button class="member-action-btn" id="toggleAdminButton" style="display: none;">–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="modal" id="deleteConfirmModal" style="display: none;">
        <div class="modal-content">
            <h2>–í—ã —É–≤–µ—Ä–µ–Ω—ã?</h2>
            <p>–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            <label>
                <input type="checkbox" id="deleteConfirmCheckbox">
                –Ø –ø–æ–Ω–∏–º–∞—é, —á—Ç–æ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ
            </label>
            <button id="confirmDeleteButton" disabled>–£–¥–∞–ª–∏—Ç—å</button>
            <button id="cancelDeleteButton">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è -->
    <div class="modal" id="voicePreviewModal" style="display: none;">
        <div class="modal-content">
            <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è</h2>
            <audio id="voicePreviewAudio" controls></audio>
            <div class="modal-buttons">
                <button id="sendVoiceButton">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                <button id="cancelVoiceButton">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ -->
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="user-actions">
                <button id="menuButton" class="menu-btn">‚ò∞</button>
                <div class="dropdown-menu" id="dropdownMenu" style="display: none;">
                    <button id="viewMyProfileButton">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</button>
                    <button id="createGroupButtonMenu">–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
                    <button id="logoutButton">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
                    <button id="deleteProfileButton">–£–¥–∞–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
                </div>
            </div>
            <div class="search-area">
                <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ @username">
                <button id="clearSearch" class="clear-search-btn" style="display: none;">‚úñ</button>
            </div>
            <div id="contactList"></div>
        </div>
        <div class="messenger">
            <div class="header" id="chatHeader">
                <span>–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</span>
                <button id="viewContactProfileButton" style="display: none;">üë§</button>
                <button id="editGroupButton" style="display: none;">‚öôÔ∏è</button>
            </div>
            <div class="chat" id="chat"></div>
            <div class="input-area">
                <div class="media-preview" id="mediaPreview" style="display: none;">
                    <img id="previewImage" style="display: none;" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è">
                    <video id="previewVideo" controls style="display: none;"></video>
                    <button id="cancelMediaPreview" class="cancel-media-btn">üóëÔ∏è</button>
                </div>
                <canvas id="audioWaveform" style="display: none;"></canvas>
                <div class="input-controls">
                    <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ">
                    <label for="messageMediaInput" class="media-btn">üìé</label>
                    <input type="file" id="messageMediaInput" accept="image/jpeg,image/png,image/gif,video/mp4,video/webm" style="display: none;">
                    <button id="recordVoiceBtn" class="media-btn">üé§</button>
                    <button id="sendMessageBtn">‚úàÔ∏è</button>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –Ω–∞—à JavaScript —Å defer -->
<script>    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Supabase
    const supabaseUrl = 'https://jppczsckjihbwpxklazy.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpwcGN6c2NramloYndweGtsYXp5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM5MjA4MjMsImV4cCI6MjA1OTQ5NjgyM30.2PWGaFa5ymAjru-TgyknhCb91_S-1EQpLAk8y9DGggI';
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
    
    // Cloudinary API-–∫–ª—é—á–∏
    const CLOUDINARY_CLOUD_NAME = 'ds9ghsha0';
    const CLOUDINARY_API_KEY = '213912739345749';
    const CLOUDINARY_UPLOAD_PRESET = 'messenger_upload';
    
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è —á–∞—Ç–∞
    let currentUser = null;
    let selectedChat = null;
    let selectedChatType = null;
    let allUsers = [];
    let allGroups = [];
    let selectedMemberId = null;
    let currentSubscription = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let audioAnalyser = null;
    let audioContext = null;
    let audioBlob = null;
    
    // –î–µ–±–∞—É–Ω—Å –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
    function debounce(func, wait) {
        let timeout;
        return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤ –∏ –≥—Ä—É–ø–ø
    const loadContactsDebounced = debounce(async () => {
        const contactList = document.getElementById('contactList');
        contactList.innerHTML = '';
    
        if (allUsers.length === 0) {
            const { data: users, error: usersError } = await supabase
                .from('profiles')
                .select('*')
                .neq('id', currentUser.id);
    
            if (usersError) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', usersError);
                return;
            }
            allUsers = users;
        }
    
        if (allGroups.length === 0) {
            const { data: groups, error: groupsError } = await supabase
                .from('groups')
                .select('*')
                .in('id', (await supabase
                    .from('group_members')
                    .select('group_id')
                    .eq('user_id', currentUser.id)).data.map(m => m.group_id));
    
            if (groupsError) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä—É–ø–ø:', groupsError);
                return;
            }
            allGroups = groups;
        }
    
        const searchQuery = document.getElementById('searchInput').value.trim().toLowerCase();
    
        if (!searchQuery) {
            allUsers.forEach(user => {
                const div = document.createElement('div');
                div.classList.add('contact');
                div.setAttribute('data-id', user.id);
                div.setAttribute('data-type', 'user');
                div.innerHTML = `
                    <div class="contact-avatar" style="${user.profile_picture ? 'background: none;' : ''}">
                        ${user.profile_picture ? `<img src="${user.profile_picture}" alt="${user.username}">` : user.username[0]}
                    </div>
                    <span class="contact-name">${user.username}${user.unique_username ? ` (${user.unique_username})` : ''}</span>
                `;
                div.addEventListener('click', () => selectChat(user.id, 'user', user.username));
                contactList.appendChild(div);
            });
    
            allGroups.forEach(group => {
                const div = document.createElement('div');
                div.classList.add('contact');
                div.setAttribute('data-id', group.id);
                div.setAttribute('data-type', 'group');
                div.innerHTML = `
                    <div class="contact-avatar" style="${group.avatar_url ? 'background: none;' : ''}">
                        ${group.avatar_url ? `<img src="${group.avatar_url}" alt="${group.name}">` : 'üë•'}
                    </div>
                    <span class="contact-name">${group.name}${group.unique_username ? ` (${group.unique_username})` : ''}</span>
                `;
                div.addEventListener('click', () => selectChat(group.id, 'group', group.name));
                contactList.appendChild(div);
            });
        } else {
            allUsers
                .filter(user => 
                    user.username.toLowerCase().includes(searchQuery) || 
                    (user.unique_username && user.unique_username.toLowerCase().includes(searchQuery))
                )
                .forEach(user => {
                    const div = document.createElement('div');
                    div.classList.add('contact');
                    div.setAttribute('data-id', user.id);
                    div.setAttribute('data-type', 'user');
                    div.innerHTML = `
                        <div class="contact-avatar" style="${user.profile_picture ? 'background: none;' : ''}">
                            ${user.profile_picture ? `<img src="${user.profile_picture}" alt="${user.username}">` : user.username[0]}
                        </div>
                        <span class="contact-name">${user.username}${user.unique_username ? ` (${user.unique_username})` : ''}</span>
                    `;
                    div.addEventListener('click', () => selectChat(user.id, 'user', user.username));
                    contactList.appendChild(div);
                });
    
            const { data: allAvailableGroups, error: groupsError } = await supabase
                .from('groups')
                .select('*');
    
            if (groupsError) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –≥—Ä—É–ø–ø:', groupsError);
                return;
            }
    
            allAvailableGroups
                .filter(group => 
                    group.name.toLowerCase().includes(searchQuery) || 
                    (group.unique_username && group.unique_username.toLowerCase().includes(searchQuery))
                )
                .forEach(group => {
                    const isMember = allGroups.some(g => g.id === group.id);
                    const div = document.createElement('div');
                    div.classList.add('contact');
                    div.setAttribute('data-id', group.id);
                    div.setAttribute('data-type', 'group');
                    div.innerHTML = `
                        <div class="contact-avatar" style="${group.avatar_url ? 'background: none;' : ''}">
                            ${group.avatar_url ? `<img src="${group.avatar_url}" alt="${group.name}">` : 'üë•'}
                        </div>
                        <span class="contact-name">${group.name}${group.unique_username ? ` (${group.unique_username})` : ''}</span>
                        ${!isMember ? '<button class="request-join-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>' : ''}
                    `;
                    if (!isMember) {
                        const joinBtn = div.querySelector('.request-join-btn');
                        joinBtn.addEventListener('click', async (e) => {
                            e.stopPropagation();
                            const { error } = await supabase
                                .from('group_join_requests')
                                .insert({ group_id: group.id, user_id: currentUser.id, status: 'pending' });
                            if (error) {
                                if (error.code === '23505') {
                                    alert('–í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∑–∞—è–≤–∫—É –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ!');
                                } else {
                                    console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏:', error);
                                    alert('–û—à–∏–±–∫–∞: ' + error.message);
                                }
                            } else {
                                await supabase
                                    .from('messages')
                                    .insert({
                                        group_id: group.id,
                                        sender_id: null,
                                        receiver_id: null,
                                        text: `${currentUser.profile.username} –ø–æ–¥–∞–ª –∑–∞—è–≤–∫—É –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ`,
                                        is_system: true
                                    });
                                alert('–ó–∞—è–≤–∫–∞ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
                            }
                        });
                    }
                    div.addEventListener('click', () => {
                        if (isMember) selectChat(group.id, 'group', group.name);
                    });
                    contactList.appendChild(div);
                });
        }
    }, 300);
    
    // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –≤ Cloudinary
    async function uploadToCloudinary(file, folder) {
        if (!file) throw new Error('–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω');
    
        const formData = new FormData();
        formData.append('file', file);
        formData.append('folder', folder);
        formData.append('public_id', `${Date.now()}_${file.name || 'audio'}`);
        formData.append('api_key', CLOUDINARY_API_KEY);
        formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
    
        const resourceType = file.type.startsWith('video/') ? 'video' : 
                            file.type.startsWith('audio/') ? 'video' : 'image';
        const response = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/${resourceType}/upload`, {
            method: 'POST',
            body: formData,
        });
    
        const result = await response.json();
        if (result.error) throw new Error(result.error.message);
        return result.secure_url;
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
    function formatTimestamp(timestamp) {
        const date = new Date(timestamp);
        return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }
    
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã —Ä–æ–∂–¥–µ–Ω–∏—è
    function formatDate(date) {
        if (!date) return '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        const d = new Date(date);
        return d.toLocaleDateString('ru-RU');
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    async function checkUser() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            if (!user.email_confirmed_at) {
                document.getElementById('awaitConfirmationModal').style.display = 'flex';
                return;
            }
    
            const { data: profile, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id)
                .single();
    
            if (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", error);
                showAuthModal();
            } else {
                currentUser = { ...user, profile };
                document.getElementById('authModal').style.display = 'none';
                document.getElementById('registerModal').style.display = 'none';
                document.getElementById('awaitConfirmationModal').style.display = 'none';
                loadContactsDebounced();
            }
        } else {
            showAuthModal();
        }
    }
    
    // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –≤—Ö–æ–¥–∞
    function showAuthModal() {
        document.getElementById('authModal').style.display = 'flex';
        document.getElementById('registerModal').style.display = 'none';
        document.getElementById('awaitConfirmationModal').style.display = 'none';
    }
    
    // –ü–æ–∫–∞–∑ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    function showRegisterModal() {
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('registerModal').style.display = 'flex';
        document.getElementById('awaitConfirmationModal').style.display = 'none';
    }
    
    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –≤—Ö–æ–¥–æ–º –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–µ–π
    document.getElementById('toggleAuth').addEventListener('click', showRegisterModal);
    document.getElementById('toggleLogin').addEventListener('click', showAuthModal);
    
    // –í—Ö–æ–¥
    document.getElementById('authButton').addEventListener('click', async () => {
        const email = document.getElementById('emailInput').value.trim();
        const password = document.getElementById('passwordInput').value.trim();
    
        if (!email || !password) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            return;
        }
    
        const { error } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
            console.error("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:", error);
            alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
        } else {
            checkUser();
        }
    });
    
    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    document.getElementById('registerButton').addEventListener('click', async () => {
        const username = document.getElementById('usernameInput').value.trim();
        const email = document.getElementById('registerEmailInput').value.trim();
        const password = document.getElementById('registerPasswordInput').value.trim();
    
        if (!username || !email || !password) {
            alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            return;
        }
    
        const { data: { user }, error: authError } = await supabase.auth.signUp({
            email,
            password,
            options: { emailRedirectTo: window.location.origin }
        });
    
        if (authError) {
            console.error("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:", authError);
            alert("–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: " + authError.message);
            return;
        }
    
        const { data: existingProfile, error: fetchError } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();
    
        if (fetchError && fetchError.code !== 'PGRST116') {
            console.error("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", fetchError);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è: " + fetchError.message);
            await supabase.auth.signOut();
            return;
        }
    
        if (existingProfile) {
            const { error: deleteError } = await supabase
                .from('profiles')
                .delete()
                .eq('id', user.id);
            if (deleteError) {
                console.error("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è:", deleteError);
                alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è: " + deleteError.message);
                await supabase.auth.signOut();
                return;
            }
        }
    
        const { error: profileError } = await supabase
            .from('profiles')
            .insert({ id: user.id, username, unique_username: null });
    
        if (profileError) {
            console.error("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", profileError.message);
            alert("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: " + profileError.message);
            await supabase.auth.signOut();
            return;
        }
    
        document.getElementById('registerModal').style.display = 'none';
        document.getElementById('awaitConfirmationModal').style.display = 'flex';
    });
    
    // –û—Ç–º–µ–Ω–∞ –æ–∂–∏–¥–∞–Ω–∏—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    document.getElementById('cancelAwaitButton').addEventListener('click', async () => {
        await supabase.auth.signOut();
        document.getElementById('awaitConfirmationModal').style.display = 'none';
        showAuthModal();
    });
    
    // –ü–æ–∫–∞–∑ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ –º–µ–Ω—é
    document.getElementById('menuButton').addEventListener('click', () => {
        const dropdown = document.getElementById('dropdownMenu');
        dropdown.style.display = dropdown.style.display === 'none' ? 'flex' : 'none';
    });
    
    // –ü–æ–∫–∞–∑ –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.getElementById('viewMyProfileButton').addEventListener('click', () => {
        showProfile(currentUser.profile, true);
        document.getElementById('dropdownMenu').style.display = 'none';
    });
    
    // –ü–æ–∫–∞–∑ –ø—Ä–æ—Ñ–∏–ª—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
    document.getElementById('viewContactProfileButton').addEventListener('click', async () => {
        if (selectedChatType === 'user') {
            const contact = allUsers.find(user => user.id === selectedChat);
            if (contact) {
                showProfile(contact, false);
            } else {
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', selectedChat)
                    .single();
                if (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞: ' + error.message);
                } else {
                    showProfile(profile, false);
                }
            }
        }
    });
    
    // –ü–æ–∫–∞–∑ –ø—Ä–æ—Ñ–∏–ª—è
    function showProfile(profile, isOwnProfile) {
        const modal = document.getElementById('viewProfileModal');
        const username = document.getElementById('viewProfileUsername');
        const uniqueUsername = document.getElementById('viewProfileUniqueUsername');
        const picture = document.getElementById('viewProfilePicture');
        const bio = document.getElementById('viewProfileBio');
        const birthdate = document.getElementById('viewProfileBirthdate');
        const editButton = document.getElementById('editProfileButton');
    
        if (!profile) {
            alert('–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!');
            return;
        }
    
        username.textContent = profile.username || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        uniqueUsername.textContent = profile.unique_username || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        picture.src = profile.profile_picture || '';
        picture.style.display = profile.profile_picture ? 'block' : 'none';
        bio.textContent = profile.bio || '–ù–µ —É–∫–∞–∑–∞–Ω–æ';
        birthdate.textContent = formatDate(profile.birthdate);
    
        editButton.style.display = isOwnProfile ? 'block' : 'none';
    
        modal.style.display = 'flex';
        modal.style.zIndex = '2000';
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Ñ–∏–ª—è
    document.querySelector('#viewProfileModal .modal-close-btn').addEventListener('click', () => {
        document.getElementById('viewProfileModal').style.display = 'none';
    });
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('editProfileButton').addEventListener('click', () => {
        document.getElementById('viewProfileModal').style.display = 'none';
        const modal = document.getElementById('editProfileModal');
        const usernameInput = document.getElementById('editUsernameInput');
        const uniqueUsernameInput = document.getElementById('uniqueUsernameInput');
        const picturePreview = document.getElementById('editProfilePicturePreview');
        const bioInput = document.getElementById('bioInput');
        const birthdateInput = document.getElementById('birthdateInput');
    
        usernameInput.value = currentUser.profile.username || '';
        uniqueUsernameInput.value = currentUser.profile.unique_username || '';
        picturePreview.src = currentUser.profile.profile_picture || '';
        picturePreview.style.display = currentUser.profile.profile_picture ? 'block' : 'none';
        bioInput.value = currentUser.profile.bio || '';
        birthdateInput.value = currentUser.profile.birthdate || '';
    
        modal.style.display = 'flex';
    });
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('profilePictureInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const preview = document.getElementById('editProfilePicturePreview');
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
        }
    });
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('saveProfileButton').addEventListener('click', async () => {
        const fileInput = document.getElementById('profilePictureInput');
        const usernameInput = document.getElementById('editUsernameInput').value.trim();
        const uniqueUsernameInput = document.getElementById('uniqueUsernameInput').value.trim();
        const bio = document.getElementById('bioInput').value.trim();
        const birthdate = document.getElementById('birthdateInput').value;
        let profilePicture = currentUser.profile.profile_picture;
    
        if (!usernameInput) {
            alert('–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!');
            return;
        }
    
        let uniqueUsername = uniqueUsernameInput;
        if (uniqueUsername && !uniqueUsername.startsWith('@')) uniqueUsername = `@${uniqueUsername}`;
        if (uniqueUsername) {
            const { data: existingUser, error } = await supabase
                .from('profiles')
                .select('id')
                .eq('unique_username', uniqueUsername)
                .neq('id', currentUser.id)
                .single();
    
            if (existingUser) {
                alert('–≠—Ç–æ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç!');
                return;
            }
            if (error && error.code !== 'PGRST116') {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞: ' + error.message);
                return;
            }
        }
    
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            if (file.size > 5 * 1024 * 1024) {
                alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä ‚Äî 5 –ú–ë.");
                return;
            }
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPEG, PNG –∏–ª–∏ GIF)!");
                return;
            }
    
            try {
                profilePicture = await uploadToCloudinary(file, `profile-pictures/${currentUser.id}`);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ:", error);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: " + error.message);
                return;
            }
        }
    
        const { error } = await supabase
            .from('profiles')
            .update({
                username: usernameInput,
                unique_username: uniqueUsername || null,
                bio: bio || null,
                birthdate: birthdate || null,
                profile_picture: profilePicture
            })
            .eq('id', currentUser.id);
    
        if (error) {
            console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:", error);
            alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: " + error.message);
        } else {
            currentUser.profile = {
                ...currentUser.profile,
                username: usernameInput,
                unique_username: uniqueUsername || null,
                bio: bio || null,
                birthdate: birthdate || null,
                profile_picture: profilePicture
            };
            document.getElementById('editProfileModal').style.display = 'none';
            allUsers = [];
            loadContactsDebounced();
            showProfile(currentUser.profile, true);
            alert('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
        }
    });
    
    document.getElementById('cancelEditProfileButton').addEventListener('click', () => {
        document.getElementById('editProfileModal').style.display = 'none';
    });
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    document.getElementById('createGroupButtonMenu').addEventListener('click', () => {
        document.getElementById('dropdownMenu').style.display = 'none';
        const modal = document.getElementById('createGroupModal');
        const membersList = document.getElementById('groupMembersList');
        const avatarPreview = document.getElementById('groupAvatarPreview');
        membersList.innerHTML = '';
        avatarPreview.style.display = 'none';
        document.getElementById('groupNameInput').value = '';
        document.getElementById('groupUniqueUsernameInput').value = '';
        document.getElementById('groupDescriptionInput').value = '';
        document.getElementById('groupAvatarInput').value = '';
    
        allUsers.forEach(user => {
            const div = document.createElement('div');
            div.classList.add('group-member-item');
            div.innerHTML = `
                <label>
                    <input type="checkbox" class="group-member-checkbox" data-user-id="${user.id}">
                    <div class="member-avatar" style="${user.profile_picture ? 'background: none;' : ''}">
                        ${user.profile_picture ? `<img src="${user.profile_picture}" alt="${user.username}">` : user.username[0]}
                    </div>
                    <span>${user.username}${user.unique_username ? ` (${user.unique_username})` : ''}</span>
                </label>
            `;
            membersList.appendChild(div);
        });
    
        modal.style.display = 'flex';
    });
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∫–∏ –≥—Ä—É–ø–ø—ã (—Å–æ–∑–¥–∞–Ω–∏–µ)
    document.getElementById('groupAvatarInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const preview = document.getElementById('groupAvatarPreview');
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
        }
    });
    
    document.getElementById('createGroupButton').addEventListener('click', async () => {
        const groupName = document.getElementById('groupNameInput').value.trim();
        const groupUniqueUsernameInput = document.getElementById('groupUniqueUsernameInput').value.trim();
        const groupDescription = document.getElementById('groupDescriptionInput').value.trim();
        const selectedMembers = Array.from(document.querySelectorAll('.group-member-checkbox:checked'))
            .map(cb => cb.getAttribute('data-user-id'));
        const avatarInput = document.getElementById('groupAvatarInput');
        let avatarUrl = null;
    
        if (!groupName) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã!');
            return;
        }
        if (selectedMembers.length < 2) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∏–Ω–∏–º—É–º 2 —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –¥–ª—è –≥—Ä—É–ø–ø—ã!');
            return;
        }
    
        let groupUniqueUsername = groupUniqueUsernameInput;
        if (groupUniqueUsername && !groupUniqueUsername.startsWith('@')) groupUniqueUsername = `@${groupUniqueUsername}`;
        if (groupUniqueUsername) {
            const { data: existingGroup, error } = await supabase
                .from('groups')
                .select('id')
                .eq('unique_username', groupUniqueUsername)
                .single();
    
            if (existingGroup) {
                alert('–≠—Ç–æ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç!');
                return;
            }
            if (error && error.code !== 'PGRST116') {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞: ' + error.message);
                return;
            }
        }
    
        document.getElementById('createGroupModal').style.display = 'none';
        document.getElementById('loadingModal').style.display = 'flex';
    
        if (avatarInput.files.length > 0) {
            const file = avatarInput.files[0];
            if (file.size > 5 * 1024 * 1024) {
                alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä ‚Äî 5 –ú–ë.");
                document.getElementById('loadingModal').style.display = 'none';
                return;
            }
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPEG, PNG –∏–ª–∏ GIF)!");
                document.getElementById('loadingModal').style.display = 'none';
                return;
            }
    
            try {
                avatarUrl = await uploadToCloudinary(file, `group-avatars/${Date.now()}`);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏:", error);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏: " + error.message);
                document.getElementById('loadingModal').style.display = 'none';
                return;
            }
        }
    
        selectedMembers.push(currentUser.id);
    
        const { data: group, error: groupError } = await supabase
            .from('groups')
            .insert({
                name: groupName,
                unique_username: groupUniqueUsername || null,
                description: groupDescription || null,
                avatar_url: avatarUrl,
                owner_id: currentUser.id
            })
            .select()
            .single();
    
        if (groupError) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã:', groupError);
            alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã: ' + groupError.message);
            document.getElementById('loadingModal').style.display = 'none';
            return;
        }
    
        const groupMembers = selectedMembers.map(userId => ({
            group_id: group.id,
            user_id: userId,
            is_admin: userId === currentUser.id
        }));
    
        const { error: membersError } = await supabase
            .from('group_members')
            .insert(groupMembers);
    
        if (membersError) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:', membersError);
            alert('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ' + membersError.message);
            document.getElementById('loadingModal').style.display = 'none';
            return;
        }
    
        const { error: messageError } = await supabase
            .from('messages')
            .insert({
                group_id: group.id,
                sender_id: null,
                receiver_id: null,
                text: `–ì—Ä—É–ø–ø–∞ "${groupName}" –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞`,
                is_system: true
            });
    
        if (messageError) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', messageError);
        }
    
        document.getElementById('loadingModal').style.display = 'none';
        allGroups = [];
        loadContactsDebounced();
    });
    
    document.getElementById('cancelGroupButton').addEventListener('click', () => {
        document.getElementById('createGroupModal').style.display = 'none';
    });
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    async function isUserAdmin(groupId, userId) {
        const { data, error } = await supabase
            .from('group_members')
            .select('is_admin')
            .eq('group_id', groupId)
            .eq('user_id', userId)
            .single();
    
        if (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∞:', error);
            return false;
        }
        return data.is_admin || false;
    }
    
    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    document.getElementById('editGroupButton').addEventListener('click', async () => {
        if (selectedChatType !== 'group') return;
    
        const group = allGroups.find(g => g.id === selectedChat);
        if (!group) return;
    
        const isAdmin = await isUserAdmin(selectedChat, currentUser.id);
        const isOwner = group.owner_id === currentUser.id;
    
        const modal = document.getElementById('editGroupModal');
        const avatarPreview = document.getElementById('editGroupAvatarPreview');
        const nameInput = document.getElementById('editGroupNameInput');
        const uniqueUsernameInput = document.getElementById('editGroupUniqueUsernameInput');
        const descriptionInput = document.getElementById('editGroupDescriptionInput');
        const membersList = document.getElementById('editGroupMembersList');
        const ownerDetails = document.getElementById('groupOwnerDetails');
        const deleteButton = document.getElementById('deleteGroupButton');
        const leaveButton = document.getElementById('leaveGroupButton');
        const addMembersButton = document.getElementById('addMembersButton');
    
        nameInput.value = group.name;
        uniqueUsernameInput.value = group.unique_username || '';
        descriptionInput.value = group.description || '';
        avatarPreview.src = group.avatar_url || '';
        avatarPreview.style.display = group.avatar_url ? 'block' : 'none';
    
        deleteButton.style.display = isOwner ? 'block' : 'none';
        leaveButton.style.display = !isOwner ? 'block' : 'none';
        addMembersButton.style.display = (isOwner || isAdmin) ? 'block' : 'none';
        nameInput.disabled = !(isOwner || isAdmin);
        uniqueUsernameInput.disabled = !(isOwner || isAdmin);
        descriptionInput.disabled = !(isOwner || isAdmin);
    
        const { data: ownerProfile, error: ownerError } = await supabase
            .from('profiles')
            .select('username, unique_username, profile_picture')
            .eq('id', group.owner_id)
            .single();
    
        if (ownerError) {
            ownerDetails.innerHTML = '<span>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–∑–¥–∞—Ç–µ–ª–µ</span>';
        } else {
            ownerDetails.innerHTML = `
                <div class="owner-avatar" style="${ownerProfile.profile_picture ? 'background: none;' : ''}">
                    ${ownerProfile.profile_picture ? `<img src="${ownerProfile.profile_picture}" alt="${ownerProfile.username}">` : ownerProfile.username[0]}
                </div>
                <span>${ownerProfile.username}${ownerProfile.unique_username ? ` (${ownerProfile.unique_username})` : ''}</span>
            `;
        }
    
        const { data: currentMembers, error: membersError } = await supabase
            .from('group_members')
            .select('user_id, is_admin, profiles!inner(username, profile_picture, unique_username)')
            .eq('group_id', group.id);
    
        if (membersError) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:', membersError);
            return;
        }
    
        membersList.innerHTML = '';
        currentMembers.forEach(member => {
            const div = document.createElement('div');
            div.classList.add('group-member-item');
            div.setAttribute('data-user-id', member.user_id);
            div.innerHTML = `
                <div class="member-avatar" style="${member.profiles.profile_picture ? 'background: none;' : ''}">
                    ${member.profiles.profile_picture ? `<img src="${member.profiles.profile_picture}" alt="${member.profiles.username}">` : member.profiles.username[0]}
                </div>
                <span>${member.profiles.username}${member.profiles.unique_username ? ` (${member.profiles.unique_username})` : ''}${member.is_admin ? ' (–ê–¥–º–∏–Ω)' : ''}</span>
            `;
            div.addEventListener('click', (e) => {
                e.stopPropagation();
                if (member.user_id === currentUser.id) return;
    
                selectedMemberId = member.user_id;
                const actionsModal = document.getElementById('memberActionsModal');
                const toggleAdminBtn = document.getElementById('toggleAdminButton');
                const removeMemberBtn = document.getElementById('removeMemberButton');
                const messageMemberBtn = document.getElementById('messageMemberButton');
                const viewMemberProfileBtn = document.getElementById('viewMemberProfileButton');
    
                if (isOwner || isAdmin) {
                    toggleAdminBtn.style.display = 'block';
                    toggleAdminBtn.textContent = member.is_admin ? '–°–Ω—è—Ç—å –∞–¥–º–∏–Ω–∞' : '–°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º';
                    removeMemberBtn.style.display = 'block';
                } else {
                    toggleAdminBtn.style.display = 'none';
                    removeMemberBtn.style.display = 'none';
                }
    
                messageMemberBtn.style.display = 'block';
                viewMemberProfileBtn.style.display = 'block';
    
                actionsModal.style.display = 'block';
                const rect = div.getBoundingClientRect();
                actionsModal.style.left = `${rect.right + 10}px`;
                actionsModal.style.top = `${rect.top}px`;
            });
            membersList.appendChild(div);
        });
    
        const { data: requests, error: reqError } = await supabase
            .from('group_join_requests')
            .select('user_id, profiles!inner(username, profile_picture)')
            .eq('group_id', group.id)
            .eq('status', 'pending');
    
        if (reqError) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫:', reqError);
            return;
        }
    
        const requestsContainer = document.getElementById('groupRequests');
        requestsContainer.innerHTML = '';
        if (requests.length > 0 && (isOwner || isAdmin)) {
            requestsContainer.style.display = 'block';
            const requestsDiv = document.createElement('div');
            requestsDiv.classList.add('group-requests');
            requestsDiv.innerHTML = '<h3>–ó–∞—è–≤–∫–∏ –Ω–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏–µ</h3><div class="requests-list"></div>';
            const requestsList = requestsDiv.querySelector('.requests-list');
    
            requests.forEach(req => {
                const div = document.createElement('div');
                div.classList.add('request-item');
                div.innerHTML = `
                    <div class="request-avatar" style="${req.profiles.profile_picture ? 'background: none;' : ''}">
                        ${req.profiles.profile_picture ? `<img src="${req.profiles.profile_picture}" alt="${req.profiles.username}">` : req.profiles.username[0]}
                    </div>
                    <span class="request-username">${req.profiles.username}</span>
                    <div class="request-actions">
                        <button class="approve-btn" data-user-id="${req.user_id}" title="–û–¥–æ–±—Ä–∏—Ç—å">‚úî</button>
                        <button class="reject-btn" data-user-id="${req.user_id}" title="–û—Ç–∫–ª–æ–Ω–∏—Ç—å">‚úñ</button>
                    </div>
                `;
                requestsList.appendChild(div);
            });
            requestsContainer.appendChild(requestsDiv);
    
            requestsDiv.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const userId = btn.getAttribute('data-user-id');
                    const { data: userProfile } = await supabase
                        .from('profiles')
                        .select('username')
                        .eq('id', userId)
                        .single();
    
                    await supabase
                        .from('group_join_requests')
                        .update({ status: 'approved' })
                        .eq('group_id', group.id)
                        .eq('user_id', userId);
    
                    await supabase
                        .from('group_members')
                        .insert({ group_id: group.id, user_id: userId, is_admin: false });
    
                    await supabase
                        .from('messages')
                        .insert({
                            group_id: group.id,
                            sender_id: null,
                            receiver_id: null,
                            text: `–ó–∞—è–≤–∫–∞ ${userProfile.username} –±—ã–ª–∞ –ø—Ä–∏–Ω—è—Ç–∞`,
                            is_system: true
                        });
    
                    alert('–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!');
                    document.getElementById('editGroupButton').click();
                });
            });
    
            requestsDiv.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const userId = btn.getAttribute('data-user-id');
                    const { data: userProfile } = await supabase
                        .from('profiles')
                        .select('username')
                        .eq('id', userId)
                        .single();
    
                    await supabase
                        .from('group_join_requests')
                        .update({ status: 'rejected' })
                        .eq('group_id', group.id)
                        .eq('user_id', userId);
    
                    await supabase
                        .from('messages')
                        .insert({
                            group_id: group.id,
                            sender_id: null,
                            receiver_id: null,
                            text: `–ó–∞—è–≤–∫–∞ ${userProfile.username} –±—ã–ª–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞`,
                            is_system: true
                        });
    
                    alert('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞!');
                    document.getElementById('editGroupButton').click();
                });
            });
        } else {
            requestsContainer.style.display = 'none';
        }
    
        modal.style.display = 'flex';
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø—ã
    document.getElementById('closeEditGroupModal').addEventListener('click', () => {
        document.getElementById('editGroupModal').style.display = 'none';
    });
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    document.getElementById('addMembersButton').addEventListener('click', async () => {
        const group = allGroups.find(g => g.id === selectedChat);
        const isAdmin = await isUserAdmin(selectedChat, currentUser.id);
        if (!(group.owner_id === currentUser.id || isAdmin)) {
            alert('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤!');
            return;
        }
    
        const modal = document.createElement('div');
        modal.classList.add('modal');
        modal.innerHTML = `
            <div class="modal-content group-modal">
                <button class="modal-close-btn" id="closeAddMembersModal">‚úñ</button>
                <h2>–î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
                <div class="group-members-container">
                    <h3>–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h3>
                    <div id="addMembersList" class="group-members-list"></div>
                </div>
                <div class="modal-buttons">
                    <button id="saveNewMembersButton">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    
        const addMembersList = modal.querySelector('#addMembersList');
        const currentMemberIds = (await supabase
            .from('group_members')
            .select('user_id')
            .eq('group_id', group.id)).data.map(m => m.user_id);
    
        allUsers.filter(user => !currentMemberIds.includes(user.id)).forEach(user => {
            const div = document.createElement('div');
            div.classList.add('group-member-item');
            div.innerHTML = `
                <label>
                    <input type="checkbox" class="group-member-checkbox" data-user-id="${user.id}">
                    <div class="member-avatar" style="${user.profile_picture ? 'background: none;' : ''}">
                        ${user.profile_picture ? `<img src="${user.profile_picture}" alt="${user.username}">` : user.username[0]}
                    </div>
                    <span>${user.username}${user.unique_username ? ` (${user.unique_username})` : ''}</span>
                </label>
            `;
            addMembersList.appendChild(div);
        });
    
        modal.querySelector('#closeAddMembersModal').addEventListener('click', () => {
            document.body.removeChild(modal);
        });
    
        modal.querySelector('#saveNewMembersButton').addEventListener('click', async () => {
            const selectedNewMembers = Array.from(modal.querySelectorAll('.group-member-checkbox:checked'))
                .map(cb => cb.getAttribute('data-user-id'));
    
            if (selectedNewMembers.length === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞!');
                return;
            }
    
            const newGroupMembers = selectedNewMembers.map(userId => ({
                group_id: group.id,
                user_id: userId,
                is_admin: false
            }));
    
            const { error } = await supabase
                .from('group_members')
                .insert(newGroupMembers);
    
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:', error);
                alert('–û—à–∏–±–∫–∞: ' + error.message);
            } else {
                const usernames = await Promise.all(selectedNewMembers.map(async userId => {
                    const { data } = await supabase
                        .from('profiles')
                        .select('username')
                        .eq('id', userId)
                        .single();
                    return data.username;
                }));
    
                await supabase
                    .from('messages')
                    .insert({
                        group_id: group.id,
                        sender_id: null,
                        receiver_id: null,
                        text: `${usernames.join(', ')} –±—ã–ª–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≥—Ä—É–ø–ø—É`,
                        is_system: true
                    });
    
                alert('–£—á–∞—Å—Ç–Ω–∏–∫–∏ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω—ã!');
                document.body.removeChild(modal);
                document.getElementById('editGroupButton').click();
            }
        });
    });
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∫–∏ –≥—Ä—É–ø–ø—ã (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
    document.getElementById('editGroupAvatarInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const preview = document.getElementById('editGroupAvatarPreview');
            preview.src = URL.createObjectURL(file);
            preview.style.display = 'block';
        }
    });
    
    document.getElementById('saveGroupButton').addEventListener('click', async () => {
        const group = allGroups.find(g => g.id === selectedChat);
        const isAdmin = await isUserAdmin(selectedChat, currentUser.id);
        if (!(group.owner_id === currentUser.id || isAdmin)) {
            alert('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≥—Ä—É–ø–ø—ã!');
            return;
        }
    
        const groupName = document.getElementById('editGroupNameInput').value.trim();
        const groupUniqueUsernameInput = document.getElementById('editGroupUniqueUsernameInput').value.trim();
        const groupDescription = document.getElementById('editGroupDescriptionInput').value.trim();
        const avatarInput = document.getElementById('editGroupAvatarInput');
        let avatarUrl = group.avatar_url;
    
        if (!groupName) {
            alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã!');
            return;
        }
    
        let groupUniqueUsername = groupUniqueUsernameInput;
        if (groupUniqueUsername && !groupUniqueUsername.startsWith('@')) groupUniqueUsername = `@${groupUniqueUsername}`;
        if (groupUniqueUsername) {
            const { data: existingGroup, error } = await supabase
                .from('groups')
                .select('id')
                .eq('unique_username', groupUniqueUsername)
                .neq('id', selectedChat)
                .single();
    
            if (existingGroup) {
                alert('–≠—Ç–æ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç!');
                return;
            }
            if (error && error.code !== 'PGRST116') {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –Ω–∏–∫–∞: ' + error.message);
                return;
            }
        }
    
        if (avatarInput.files.length > 0) {
            const file = avatarInput.files[0];
            if (file.size > 5 * 1024 * 1024) {
                alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä ‚Äî 5 –ú–ë.");
                return;
            }
            const allowedTypes = ['image/jpeg', 'image/png', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPEG, PNG –∏–ª–∏ GIF)!");
                return;
            }
    
            try {
                avatarUrl = await uploadToCloudinary(file, `group-avatars/${selectedChat}`);
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏:", error);
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∫–∏: " + error.message);
                return;
            }
        }
    
        const { error: updateError } = await supabase
            .from('groups')
            .update({
                name: groupName,
                unique_username: groupUniqueUsername || null,
                description: groupDescription || null,
                avatar_url: avatarUrl
            })
            .eq('id', selectedChat);
    
        if (updateError) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:', updateError);
            alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã: ' + updateError.message);
            return;
        }
    
        document.getElementById('editGroupModal').style.display = 'none';
        allGroups = [];
        loadContactsDebounced();
        if (selectedChatType === 'group') {
            document.getElementById('chatHeader').querySelector('span').textContent = groupName;
        }
    });
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–ø–ø—ã
    document.getElementById('deleteGroupButton').addEventListener('click', () => {
        const group = allGroups.find(g => g.id === selectedChat);
        if (group.owner_id !== currentUser.id) {
            alert('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–ø–ø—É!');
            return;
        }
        document.getElementById('editGroupModal').style.display = 'none';
        const confirmModal = document.getElementById('deleteGroupConfirmModal');
        confirmModal.style.display = 'flex';
        document.getElementById('deleteGroupConfirmCheckbox').checked = false;
        document.getElementById('confirmDeleteGroupButton').disabled = true;
    });
    
    document.getElementById('deleteGroupConfirmCheckbox').addEventListener('change', (e) => {
        document.getElementById('confirmDeleteGroupButton').disabled = !e.target.checked;
    });
    
    document.getElementById('confirmDeleteGroupButton').addEventListener('click', async () => {
        const groupId = selectedChat;
    
        await supabase.from('group_members').delete().eq('group_id', groupId);
        await supabase.from('group_join_requests').delete().eq('group_id', groupId);
        await supabase.from('messages').delete().eq('group_id', groupId);
    
        const { error } = await supabase
            .from('groups')
            .delete()
            .eq('id', groupId)
            .eq('owner_id', currentUser.id);
    
        if (error) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã:', error);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø—ã: ' + error.message);
            return;
        }
    
        document.getElementById('deleteGroupConfirmModal').style.display = 'none';
        selectedChat = null;
        selectedChatType = null;
        document.getElementById('chat').innerHTML = '';
        document.getElementById('chatHeader').querySelector('span').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞';
        document.getElementById('editGroupButton').style.display = 'none';
        allGroups = [];
        loadContactsDebounced();
    });
    
    document.getElementById('cancelDeleteGroupButton').addEventListener('click', () => {
        document.getElementById('deleteGroupConfirmModal').style.display = 'none';
    });
    
    // –í—ã—Ö–æ–¥ –∏–∑ –≥—Ä—É–ø–ø—ã
    document.getElementById('leaveGroupButton').addEventListener('click', () => {
        document.getElementById('editGroupModal').style.display = 'none';
        const confirmModal = document.getElementById('leaveGroupConfirmModal');
        confirmModal.style.display = 'flex';
        document.getElementById('leaveGroupConfirmCheckbox').checked = false;
        document.getElementById('confirmLeaveGroupButton').disabled = true;
    });
    
    document.getElementById('leaveGroupConfirmCheckbox').addEventListener('change', (e) => {
        document.getElementById('confirmLeaveGroupButton').disabled = !e.target.checked;
    });
    
    document.getElementById('confirmLeaveGroupButton').addEventListener('click', async () => {
        const groupId = selectedChat;
    
        const { error } = await supabase
            .from('group_members')
            .delete()
            .eq('group_id', groupId)
            .eq('user_id', currentUser.id);
    
        if (error) {
            console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –≥—Ä—É–ø–ø—ã:', error);
            alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞ –∏–∑ –≥—Ä—É–ø–ø—ã: ' + error.message);
            return;
        }
    
        await supabase
            .from('messages')
            .insert({
                group_id: groupId,
                sender_id: null,
                receiver_id: null,
                text: `${currentUser.profile.username} –≤—ã—à–µ–ª –∏–∑ –≥—Ä—É–ø–ø—ã`,
                is_system: true
            });
    
        document.getElementById('leaveGroupConfirmModal').style.display = 'none';
        selectedChat = null;
        selectedChatType = null;
        document.getElementById('chat').innerHTML = '';
        document.getElementById('chatHeader').querySelector('span').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞';
        document.getElementById('editGroupButton').style.display = 'none';
        allGroups = [];
        loadContactsDebounced();
    });
    
    document.getElementById('cancelLeaveGroupButton').addEventListener('click', () => {
        document.getElementById('leaveGroupConfirmModal').style.display = 'none';
    });
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π —Å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –≥—Ä—É–ø–ø—ã
    document.getElementById('toggleAdminButton').addEventListener('click', async () => {
        const group = allGroups.find(g => g.id === selectedChat);
        const isAdmin = await isUserAdmin(selectedChat, currentUser.id);
        if (!(group.owner_id === currentUser.id || isAdmin)) {
            alert('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∞!');
            document.getElementById('memberActionsModal').style.display = 'none';
            return;
        }
    
        if (selectedMemberId === group.owner_id) {
            alert('–ù–µ–ª—å–∑—è –∏–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∞–¥–º–∏–Ω–∞ —É —Å–æ–∑–¥–∞—Ç–µ–ª—è –≥—Ä—É–ø–ø—ã!');
            document.getElementById('memberActionsModal').style.display = 'none';
            return;
        }
    
        const { data: member, error: fetchError } = await supabase
            .from('group_members')
            .select('is_admin, profiles!inner(username)')
            .eq('group_id', selectedChat)
            .eq('user_id', selectedMemberId)
            .single();
    
        if (fetchError) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–∞:', fetchError);
            alert('–û—à–∏–±–∫–∞: ' + fetchError.message);
            return;
        }
    
        const newAdminStatus = !member.is_admin;
        const { error: updateError } = await supabase
            .from('group_members')
            .update({ is_admin: newAdminStatus })
            .eq('group_id', selectedChat)
            .eq('user_id', selectedMemberId);
    
        if (updateError) {
            console.error('–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞–¥–º–∏–Ω–∞:', updateError);
            alert('–û—à–∏–±–∫–∞: ' + updateError.message);
        } else {
            const actionText = newAdminStatus ? '–Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º' : '—Å–Ω—è—Ç —Å —Ä–æ–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
            await supabase
                .from('messages')
                .insert({
                    group_id: selectedChat,
                    sender_id: null,
                    receiver_id: null,
                    text: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${member.profiles.username} ${actionText} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${currentUser.profile.username}`,
                    is_system: true
                });
    
            alert(`–£—á–∞—Å—Ç–Ω–∏–∫ ${newAdminStatus ? '–Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–æ–º' : '—Å–Ω—è—Ç —Å –∞–¥–º–∏–Ω–∞'}!`);
            document.getElementById('memberActionsModal').style.display = 'none';
            document.getElementById('editGroupButton').click();
        }
    });
    
    // –£–¥–∞–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞ –∏–∑ –≥—Ä—É–ø–ø—ã
    document.getElementById('removeMemberButton').addEventListener('click', async () => {
        const group = allGroups.find(g => g.id === selectedChat);
        const isAdmin = await isUserAdmin(selectedChat, currentUser.id);
        if (!(group.owner_id === currentUser.id || isAdmin)) {
            alert('–¢–æ–ª—å–∫–æ —Å–æ–∑–¥–∞—Ç–µ–ª—å –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç —É–¥–∞–ª—è—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤!');
            document.getElementById('memberActionsModal').style.display = 'none';
            return;
        }
    
        if (selectedMemberId === group.owner_id) {
            alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å–æ–∑–¥–∞—Ç–µ–ª—è –≥—Ä—É–ø–ø—ã!');
            document.getElementById('memberActionsModal').style.display = 'none';
            return;
        }
    
        const { data: member, error: fetchError } = await supabase
            .from('group_members')
            .select('profiles!inner(username)')
            .eq('group_id', selectedChat)
            .eq('user_id', selectedMemberId)
            .single();
    
        if (fetchError) {
            console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–∞:', fetchError);
            alert('–û—à–∏–±–∫–∞: ' + fetchError.message);
            return;
        }
    
        const { error: deleteError } = await supabase
            .from('group_members')
            .delete()
            .eq('group_id', selectedChat)
            .eq('user_id', selectedMemberId);
    
        if (deleteError) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞:', deleteError);
            alert('–û—à–∏–±–∫–∞: ' + deleteError.message);
        } else {
            await supabase
                .from('messages')
                .insert({
                    group_id: selectedChat,
                    sender_id: null,
                    receiver_id: null,
                    text: `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${member.profiles.username} –±—ã–ª —É–¥–∞–ª–µ–Ω –∏–∑ –≥—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ${currentUser.profile.username}`,
                    is_system: true
                });
    
            alert('–£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª–µ–Ω –∏–∑ –≥—Ä—É–ø–ø—ã!');
            document.getElementById('memberActionsModal').style.display = 'none';
            document.getElementById('editGroupButton').click();
        }
    });
    
    // –ù–∞–ø–∏—Å–∞—Ç—å –≤ –õ–°
    document.getElementById('messageMemberButton').addEventListener('click', async () => {
        if (!selectedMemberId) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω!');
            return;
        }
    
        const { data: memberProfile, error } = await supabase
            .from('profiles')
            .select('username')
            .eq('id', selectedMemberId)
            .single();
    
        if (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞: ' + error.message);
            return;
        }
    
        document.getElementById('memberActionsModal').style.display = 'none';
        document.getElementById('editGroupModal').style.display = 'none';
        await selectChat(selectedMemberId, 'user', memberProfile.username);
    });
    
    // –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
    document.getElementById('viewMemberProfileButton').addEventListener('click', async () => {
        if (!selectedMemberId) {
            alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤—ã–±—Ä–∞–Ω!');
            return;
        }
    
        const { data: memberProfile, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', selectedMemberId)
            .single();
    
        if (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞: ' + error.message);
            return;
        }
    
        document.getElementById('memberActionsModal').style.display = 'none';
        showProfile(memberProfile, false);
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
    document.addEventListener('click', (e) => {
        const actionsModal = document.getElementById('memberActionsModal');
        if (actionsModal.style.display === 'block' && !actionsModal.contains(e.target) && !e.target.closest('.group-member-item')) {
            actionsModal.style.display = 'none';
        }
    });
    
    // –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
    document.getElementById('deleteProfileButton').addEventListener('click', () => {
        document.getElementById('dropdownMenu').style.display = 'none';
        const confirmModal = document.getElementById('deleteConfirmModal');
        confirmModal.style.display = 'flex';
        document.getElementById('deleteConfirmCheckbox').checked = false;
        document.getElementById('confirmDeleteButton').disabled = true;
    });
    
    document.getElementById('deleteConfirmCheckbox').addEventListener('change', (e) => {
        document.getElementById('confirmDeleteButton').disabled = !e.target.checked;
    });
    
    document.getElementById('confirmDeleteButton').addEventListener('click', async () => {
        const { error: messagesError } = await supabase
            .from('messages')
            .delete()
            .eq('sender_id', currentUser.id);
    
        if (messagesError) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:', messagesError);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π: ' + messagesError.message);
            return;
        }
    
        const { error: groupMembersError } = await supabase
            .from('group_members')
            .delete()
            .eq('user_id', currentUser.id);
    
        if (groupMembersError) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–ª–µ–Ω—Å—Ç–≤–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö:', groupMembersError);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —á–ª–µ–Ω—Å—Ç–≤–∞ –≤ –≥—Ä—É–ø–ø–∞—Ö: ' + groupMembersError.message);
            return;
        }
    
        const { error: groupsError } = await supabase
            .from('groups')
            .delete()
            .eq('owner_id', currentUser.id);
    
        if (groupsError) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø:', groupsError);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–ø–ø: ' + groupsError.message);
            return;
        }
    
        const { error: profileError } = await supabase
            .from('profiles')
            .delete()
            .eq('id', currentUser.id);
    
        if (profileError) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', profileError);
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + profileError.message);
            return;
        }
    
        const { error: authError } = await supabase.auth.signOut();
        if (authError) {
            console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', authError);
            alert('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞: ' + authError.message);
        }
    
        document.getElementById('deleteConfirmModal').style.display = 'none';
        showAuthModal();
    });
    
    document.getElementById('cancelDeleteButton').addEventListener('click', () => {
        document.getElementById('deleteConfirmModal').style.display = 'none';
    });
    
    // –í—ã—Ö–æ–¥ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
    document.getElementById('logoutButton').addEventListener('click', async () => {
        await supabase.auth.signOut();
        document.getElementById('dropdownMenu').style.display = 'none';
        selectedChat = null;
        selectedChatType = null;
        document.getElementById('chat').innerHTML = '';
        document.getElementById('chatHeader').querySelector('span').textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞';
        showAuthModal();
    });
    
    // –ü–æ–∏—Å–∫ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
    document.getElementById('searchInput').addEventListener('input', (e) => {
        const clearBtn = document.getElementById('clearSearch');
        clearBtn.style.display = e.target.value ? 'block' : 'none';
        loadContactsDebounced();
    });
    
    document.getElementById('clearSearch').addEventListener('click', () => {
        document.getElementById('searchInput').value = '';
        document.getElementById('clearSearch').style.display = 'none';
        loadContactsDebounced();
    });
    
    // –í—ã–±–æ—Ä —á–∞—Ç–∞
    async function selectChat(id, type, name) {
        if (currentSubscription) {
            await supabase.removeChannel(currentSubscription);
            console.log(`–ü—Ä–µ–¥—ã–¥—É—â–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞–Ω–∞–ª messages:${selectedChatType}:${selectedChat} —É–¥–∞–ª–µ–Ω–∞`);
            currentSubscription = null;
        }
    
        selectedChat = id;
        selectedChatType = type;
    
        document.querySelectorAll('.contact').forEach(contact => contact.classList.remove('active'));
        const selectedContact = document.querySelector(`.contact[data-id="${id}"][data-type="${type}"]`);
        if (selectedContact) selectedContact.classList.add('active');
    
        const header = document.getElementById('chatHeader').querySelector('span');
        header.textContent = name;
    
        document.getElementById('viewContactProfileButton').style.display = type === 'user' ? 'block' : 'none';
        document.getElementById('editGroupButton').style.display = type === 'group' ? 'block' : 'none';
    
        document.getElementById('chat').innerHTML = '';
        await loadMessages();
    
        const channelName = `messages:${type}:${id}`;
        currentSubscription = supabase.channel(channelName);
    
        currentSubscription
            .on('postgres_changes', {
                event: 'INSERT',
                schema: 'public',
                table: 'messages',
                filter: type === 'user'
                    ? `or(sender_id.eq.${currentUser.id}.receiver_id.eq.${id},sender_id.eq.${id}.receiver_id.eq.${currentUser.id})`
                    : `group_id.eq.${id}`
            }, (payload) => {
                console.log('–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏–∑ –ø–æ–¥–ø–∏—Å–∫–∏:', payload.new);
                displayMessage(payload.new);
            })
            .subscribe((status) => {
                console.log(`–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ ${channelName}: ${status}`);
                if (status === 'SUBSCRIBED') {
                    console.log(`–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–Ω –Ω–∞ –∫–∞–Ω–∞–ª ${channelName}`);
                } else if (status === 'TIMED_OUT') {
                    console.error(`–¢–∞–π–º-–∞—É—Ç –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ ${channelName}. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.`);
                } else if (status === 'CLOSED') {
                    console.warn(`–ö–∞–Ω–∞–ª ${channelName} –∑–∞–∫—Ä—ã—Ç`);
                } else {
                    console.error(`–û—à–∏–±–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ ${channelName}: ${status}`);
                }
            });
    }
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π
    async function loadMessages() {
        const chat = document.getElementById('chat');
        chat.innerHTML = '';
    
        let messagesQuery;
        if (selectedChatType === 'user') {
            messagesQuery = supabase
                .from('messages')
                .select('*, profiles!messages_sender_id_fkey(username)')
                .or(`and(sender_id.eq.${currentUser.id},receiver_id.eq.${selectedChat}),and(sender_id.eq.${selectedChat},receiver_id.eq.${currentUser.id})`)
                .order('created_at', { ascending: true });
        } else if (selectedChatType === 'group') {
            messagesQuery = supabase
                .from('messages')
                .select('*, profiles!messages_sender_id_fkey(username)')
                .eq('group_id', selectedChat)
                .order('created_at', { ascending: true });
        }
    
        const { data: messages, error } = await messagesQuery;
        if (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            return;
        }
    
        messages.forEach(message => displayMessage(message));
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    function displayMessage(message) {
        const chat = document.getElementById('chat');
        if (chat.querySelector(`.message[data-message-id="${message.id}"]`) || 
            chat.querySelector(`.message[data-temp-id="${message.id}"]`)) {
            return;
        }
    
        const div = document.createElement('div');
        div.classList.add('message');
    
        if (message.id && !message.id.toString().startsWith('temp')) {
            div.setAttribute('data-message-id', message.id);
        } else {
            div.setAttribute('data-temp-id', message.id);
        }
    
        if (message.is_system) {
            div.classList.add('system-message');
            div.innerHTML = `<span>${message.text}</span>`;
        } else {
            const isOwnMessage = message.sender_id === currentUser.id;
            div.classList.add(isOwnMessage ? 'own-message' : 'other-message');
    
            let content = '';
            if (message.text) {
                content += `<p>${message.text}</p>`;
            }
            if (message.media_url) {
                if (message.media_type === 'image') {
                    content += `<img src="${message.media_url}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" class="message-media">`;
                } else if (message.media_type === 'video') {
                    content += `
                        <video controls class="message-media">
                            <source src="${message.media_url}" type="${message.media_mime}">
                        </video>
                    `;
                } else if (message.media_type === 'audio') {
                    content += `
                        <div class="voice-message">
                            <audio controls class="voice-audio">
                                <source src="${message.media_url}" type="${message.media_mime}">
                            </audio>
                        </div>
                    `;
                }
            }
    
            const senderName = message.profiles ? message.profiles.username : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
            div.innerHTML = `
                ${selectedChatType === 'group' && !isOwnMessage ? `<span class="sender-name">${senderName}</span>` : ''}
                ${content}
                <span class="timestamp">${formatTimestamp(message.created_at)}</span>
            `;
        }
    
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –∏–ª–∏ –º–µ–¥–∏–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function sendMessage() {
        const messageInput = document.getElementById('messageInput');
        const mediaInput = document.getElementById('messageMediaInput');
        const text = messageInput.value.trim();
        const file = mediaInput.files[0];
        let mediaUrl = null;
        let mediaType = null;
        let mediaMime = null;
    
        if (!text && !file) {
            alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏!');
            return;
        }
        if (!selectedChat) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è!');
            return;
        }
    
        if (file) {
            if (file.size > 10 * 1024 * 1024) {
                alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä ‚Äî 10 –ú–ë.');
                return;
            }
    
            const allowedImageTypes = ['image/jpeg', 'image/png', 'image/gif'];
            const allowedVideoTypes = ['video/mp4', 'video/webm'];
            if (allowedImageTypes.includes(file.type)) {
                mediaType = 'image';
                mediaMime = file.type;
            } else if (allowedVideoTypes.includes(file.type)) {
                mediaType = 'video';
                mediaMime = file.type;
            } else {
                alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPEG, PNG, GIF) –∏ –≤–∏–¥–µ–æ (MP4, WebM)!');
                return;
            }
    
            try {
                mediaUrl = await uploadToCloudinary(file, `chat-media/${selectedChatType}/${selectedChat}`);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞:', error);
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞: ' + error.message);
                return;
            }
        }
    
        const localMessage = {
            id: Date.now(),
            sender_id: currentUser.id,
            receiver_id: selectedChatType === 'user' ? selectedChat : null,
            group_id: selectedChatType === 'group' ? selectedChat : null,
            text: text || null,
            media_url: mediaUrl || null,
            media_type: mediaType || null,
            media_mime: mediaMime || null,
            is_system: false,
            created_at: new Date().toISOString(),
            profiles: { username: currentUser.profile.username }
        };
    
        displayMessage(localMessage);
    
        const messageData = {
            sender_id: currentUser.id,
            receiver_id: selectedChatType === 'user' ? selectedChat : null,
            group_id: selectedChatType === 'group' ? selectedChat : null,
            text: text || null,
            media_url: mediaUrl || null,
            media_type: mediaType || null,
            media_mime: mediaMime || null,
            is_system: false
        };
    
        const { data, error } = await supabase
            .from('messages')
            .insert(messageData)
            .select()
            .single();
    
        if (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
            alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
            const chat = document.getElementById('chat');
            const tempMessage = chat.querySelector(`.message[data-temp-id="${localMessage.id}"]`);
            if (tempMessage) tempMessage.remove();
        } else {
            messageInput.value = '';
            mediaInput.value = '';
            document.getElementById('mediaPreview').style.display = 'none';
            document.getElementById('previewImage').style.display = 'none';
            document.getElementById('previewVideo').style.display = 'none';
        }
    }
    
    // –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–æ–≤–æ–π –≤–æ–ª–Ω—ã –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏
    function visualizeAudio(stream) {
        const canvas = document.getElementById('audioWaveform');
        const ctx = canvas.getContext('2d');
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        audioAnalyser = audioContext.createAnalyser();
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(audioAnalyser);
        audioAnalyser.fftSize = 2048;
    
        const bufferLength = audioAnalyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
    
        canvas.width = 300;
        canvas.height = 100;
    
        function draw() {
            if (!mediaRecorder || mediaRecorder.state !== 'recording') {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                return;
            }
    
            requestAnimationFrame(draw);
            audioAnalyser.getByteTimeDomainData(dataArray);
    
            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.lineWidth = 2;
            ctx.strokeStyle = '#007bff';
    
            ctx.beginPath();
            const sliceWidth = canvas.width / bufferLength;
            let x = 0;
    
            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = (v * canvas.height) / 2;
    
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
                x += sliceWidth;
            }
    
            ctx.lineTo(canvas.width, canvas.height / 2);
            ctx.stroke();
        }
    
        draw();
    }
    
    // –ù–∞—á–∞–ª–æ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
    
            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };
    
            mediaRecorder.onstop = () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                stream.getTracks().forEach(track => track.stop());
                audioContext.close();
                showVoicePreview();
            };
    
            mediaRecorder.start();
            visualizeAudio(stream);
    
            const recordBtn = document.getElementById('recordVoiceBtn');
            recordBtn.classList.add('recording');
            recordBtn.textContent = '‚èπÔ∏è';
            document.getElementById('audioWaveform').style.display = 'block';
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
        }
    }
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏
    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
            const recordBtn = document.getElementById('recordVoiceBtn');
            recordBtn.classList.remove('recording');
            recordBtn.textContent = 'üé§';
            document.getElementById('audioWaveform').style.display = 'none';
        }
    }
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    function showVoicePreview() {
        const previewModal = document.getElementById('voicePreviewModal');
        const audioPreview = document.getElementById('voicePreviewAudio');
        audioPreview.src = URL.createObjectURL(audioBlob);
        previewModal.style.display = 'flex';
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    async function sendVoiceMessage() {
        if (!selectedChat) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è!');
            return;
        }
    
        try {
            const audioUrl = await uploadToCloudinary(audioBlob, `chat-media/${selectedChatType}/${selectedChat}`);
            const localMessage = {
                id: Date.now(),
                sender_id: currentUser.id,
                receiver_id: selectedChatType === 'user' ? selectedChat : null,
                group_id: selectedChatType === 'group' ? selectedChat : null,
                text: null,
                media_url: audioUrl,
                media_type: 'audio',
                media_mime: 'audio/webm',
                is_system: false,
                created_at: new Date().toISOString(),
                profiles: { username: currentUser.profile.username }
            };
    
            displayMessage(localMessage);
    
            const messageData = {
                sender_id: currentUser.id,
                receiver_id: selectedChatType === 'user' ? selectedChat : null,
                group_id: selectedChatType === 'group' ? selectedChat : null,
                text: null,
                media_url: audioUrl,
                media_type: 'audio',
                media_mime: 'audio/webm',
                is_system: false
            };
    
            const { data, error } = await supabase
                .from('messages')
                .insert(messageData)
                .select()
                .single();
    
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: ' + error.message);
                const chat = document.getElementById('chat');
                const tempMessage = chat.querySelector(`.message[data-temp-id="${localMessage.id}"]`);
                if (tempMessage) tempMessage.remove();
            }
    
            document.getElementById('voicePreviewModal').style.display = 'none';
            audioBlob = null;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:', error);
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ: ' + error.message);
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('sendVoiceButton').addEventListener('click', sendVoiceMessage);
    document.getElementById('cancelVoiceButton').addEventListener('click', () => {
        document.getElementById('voicePreviewModal').style.display = 'none';
        audioBlob = null;
    });
    
    // –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –º–µ–¥–∏–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    document.getElementById('messageMediaInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;
    
        const preview = document.getElementById('mediaPreview');
        const previewImage = document.getElementById('previewImage');
        const previewVideo = document.getElementById('previewVideo');
    
        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
        previewImage.style.display = 'none';
        previewVideo.style.display = 'none';
        previewImage.src = '';
        previewVideo.src = '';
    
        if (file.size > 10 * 1024 * 1024) {
            alert('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä ‚Äî 10 –ú–ë.');
            e.target.value = '';
            return;
        }
    
        const allowedImageTypes = ['image/jpeg', 'image/png', 'image/gif'];
        const allowedVideoTypes = ['video/mp4', 'video/webm'];
    
        if (allowedImageTypes.includes(file.type)) {
            previewImage.src = URL.createObjectURL(file);
            previewImage.style.display = 'block';
            preview.style.display = 'flex';
        } else if (allowedVideoTypes.includes(file.type)) {
            previewVideo.src = URL.createObjectURL(file);
            previewVideo.style.display = 'block';
            preview.style.display = 'flex';
        } else {
            alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (JPEG, PNG, GIF) –∏ –≤–∏–¥–µ–æ (MP4, WebM)!');
            e.target.value = '';
            return;
        }
    });
    
    // –û—Ç–º–µ–Ω–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–µ–¥–∏–∞
    document.getElementById('cancelMediaPreview').addEventListener('click', () => {
        const mediaInput = document.getElementById('messageMediaInput');
        const preview = document.getElementById('mediaPreview');
        const previewImage = document.getElementById('previewImage');
        const previewVideo = document.getElementById('previewVideo');
    
        mediaInput.value = '';
        preview.style.display = 'none';
        previewImage.style.display = 'none';
        previewVideo.style.display = 'none';
        previewImage.src = '';
        previewVideo.src = '';
    });
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –Ω–∞–∂–∞—Ç–∏—é Enter
    document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
    
    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
    document.getElementById('recordVoiceBtn').addEventListener('click', () => {
        const recordBtn = document.getElementById('recordVoiceBtn');
        if (recordBtn.classList.contains('recording')) {
            stopRecording();
        } else {
            startRecording();
        }
    });
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    document.addEventListener('DOMContentLoaded', () => {
        checkUser();
    });
</script>
</body>
</html>
